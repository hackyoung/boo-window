<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="boo-window">
  <template>
    <style>
      :host {
        position: fixed;
        display: block;
        background-color: white;
        z-index: 100;
      }
      .wrapper {
        width: 100%;
        height: 100%;
        overflow: hidden;
        position: relative;
      }
      .wrapper>div {
        width: 100%;
        height: 100%;
        overflow: auto;
      }
      .wrapper>a {
        position: absolute;
        z-index: 10000;
        background-color: rgba(0, 0, 0, 0);
        display: block;
        width: 10px;
        height: 10px;
      }
      .wrapper>a.tl {
        top: 0px;
        left: 0px;
      }
      .wrapper>a.tl:hover {
        cursor: nw-resize;
      }
      .wrapper>a.tr:hover {
        cursor: ne-resize;
      }
      .wrapper>a.br:hover {
        cursor: se-resize;
      }
      .wrapper>a.bl:hover {
        cursor: sw-resize;
      }
      :host([no-resize]) .wrapper>a.tl:hover,
      :host([no-resize]) .wrapper>a.tr:hover,
      :host([no-resize]) .wrapper>a.br:hover,
      :host([no-resize]) .wrapper>a.bl:hover {
        cursor: default;
      }
      .wrapper>a.tr {
        top: 0px;
        right: 0px;
      }
      .wrapper>a.bl {
        bottom: 0px;
        left: 0px;
      }
      .wrapper>a.br {
        bottom: 0px;
        right: 0px;
      }
    </style>
    <div class="wrapper">
      <a class="tl"></a>
      <a class="tr"></a>
      <a class="bl"></a>
      <a class="br"></a>
      <div>
        <div class="header">
          <slot name="header"></slot>
        </div>
        <slot name="content"></slot>
      </div>
    </div>
  </template>

  <script>

    const POS_TOP_LEFT = 'top-left';
    const POS_TOP = 'top';
    const POS_TOP_RIGHT = 'top-right';
    const POS_LEFT = 'left';
    const POS_CENTER = 'center';
    const POS_RIGHT = 'right';
    const POS_BOTTOM_LEFT = 'bottom-left';
    const POS_BOTTOM = 'bottom';
    const POS_BOTTOM_RIGHT = 'bottom-right';

    /**
     * `boo-window`
     * 
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class BooWindow extends Polymer.Element {
      static get is() { return 'boo-window'; }
      static get properties() {
        return {
          opened: {
            type: Boolean,
            value: false,
            reflectToAttribute: true,
            notify: true,
            observer: '_openedChanged'
          },
          openAnimationConfig: {
            type: Array,
            value: [{
              transform: 'scale(2.0, 2.0)',
              opacity: 0
            }, {
              transform: 'scale(1.0, 1.0)',
              opacity: 1
            }]
          },
          closeAnimationConfig: {
            type: Array,
            value: [{
              transform: 'scale(1.0, 1.0)',
              opacity: 1
            }, {
              transform: 'scale(1.5, 1.5)',
              opacity: 0
            }]
          },
          openDuration: {
            type: Number,
            value: 100
          },
          closeDuration: {
            type: Number,
            value: 100
          },
          // 从左上角为坐标原点的坐标系的横坐标
          x: {
            type: Number,
            value: 0,
            reflectToAttribute: true,
            observer: 'update',
            notify: true
          },
          // 从左上角为坐标原点的坐标系的纵坐标
          y: {
            type: Number,
            value: 0,
            reflectToAttribute: true,
            observer: 'update',
            notify: true
          },
          // 窗口高度，包括header-bar
          height: {
            type: Number,
            value: 200,
            reflectToAttribute: true,
            observer: 'update',
            notify: true
          },
          // 窗口宽度
          width: {
            type: Number,
            value: 200,
            reflectToAttribute: true,
            observer: 'update',
            notify: true
          },
          noResize: {
            type: Boolean,
            value: false,
            reflectToAttribute: true,
          },
          noMove: {
            type: Boolean,
            value: false,
            reflectToAttribute: true,
          },
          posPolicy: {
            type: String,
            observer: '_posPolicyChanged'
          },
          fixX: {
            type: Number,
            value: 0
          },
          fixY: {
            type: Number,
            value: 0
          },
          _moving: {
            type: Boolean,
            value: false
          },
          _resizing: {
            type: Boolean,
            value: false
          },
          _beginX: {
            type: Number,
          },
          _beginY: {
            type: Number,
          },
          _beginCursorX: {
            type: Number,
          },
          _beginCursorY: {
            type: Number,
          },
          _resizeTrigger: {
            type: Object,
          }
        };
      }

      center() {
        let rect = this._size();
        return {
          x: (BooWindow.screenWidth - rect.width) / 2 + this.fixX,
          y: (BooWindow.screenHeight - rect.height) / 2 + this.fixY
        };
      }

      topLeft() {
        return {
          x: this.fixX,
          y: this.fixY
        };
      }

      top() {
        let rect = this._size();
        return {
          x: (BooWindow.screenWidth - rect.width) / 2 + this.fixX,
          y: this.fixY
        };
      }

      topRight() {
        let rect = this._size();
        return {
          x: BooWindow.screenWidth - rect.width + this.fixX,
          y: this.fixY
        };
      }

      left() {
        let rect = this._size();
        return {
          x: this.fixX,
          y: (BooWindow.screenHeight - rect.height) / 2 + this.fixY,
        };
      }

      right() {
        let rect = this._size();
        return {
          x: BooWindow.screenWidth - rect.width + this.fixX,
          y: (BooWindow.screenHeight - rect.height) / 2 + this.fixY,
        };
      }

      bottomLeft() {
        let rect = this._size();
        return {
          x: this.fixX,
          y: BooWindow.screenHeight - rect.height + this.fixY,
        };
      }

      bottom() {
        let rect = this._size();
        return {
          x: (BooWindow.screenWidth - rect.width) / 2 + this.fixX,
          y: BooWindow.screenHeight - rect.height + this.fixY,
        };
      }

      bottomRight() {
        let rect = this._size();
        return {
          x: BooWindow.screenWidth - rect.width + this.fixX,
          y: BooWindow.screenHeight - rect.height + this.fixY,
        };
      }

      _size() {
        if(this.style.display == 'none') {
          console.warn('元素'+this.tagName+'没有显示，无法计算位置');
        }
        return this.getBoundingClientRect();
      }

      connectedCallback() {
        super.connectedCallback();
        let _this = this;
        let header = _this.shadowRoot.querySelector('div.header');
        _this.shadowRoot.querySelectorAll('.wrapper>a').forEach(item => {
          item.addEventListener('mousedown', e => {
            if (_this.noResize) {
              return;
            }
            _this._resizing = true;
            _this._resizeTrigger = item;
            _this._beginCursorX = e.screenX;
            _this._beginCursorY = e.screenY;
            _this._beginHeight = _this.height;
            _this._beginWidth = _this.width;
            _this._beginX = _this.x;
            _this._beginY = _this.y;
            let body = document.getElementsByTagName('body')[0];
            body.style.userSelect = 'none';
          });
        });
        header.addEventListener('mousedown', (e) => {
          if (_this.noMove) {
            return;
          }
          _this._moving = true;
          _this._beginCursorX = e.screenX;
          _this._beginCursorY = e.screenY;
          _this._beginX = _this.x;
          _this._beginY = _this.y;
          header.style.cursor = 'move';
          let body = document.getElementsByTagName('body')[0];
          body.style.userSelect = 'none';
        });
        window.addEventListener('mouseup', () => {
          _this._moving = false;
          _this._resizing = false;
          header.style.cursor = 'default';
          let body = document.getElementsByTagName('body')[0];
          body.style.userSelect = 'text';
        });
        window.addEventListener('mousemove', (e) => {
          if (_this._moving) {
            _this.x = _this._beginX + e.screenX - _this._beginCursorX;
            _this.y = _this._beginY + e.screenY - _this._beginCursorY;
          }
          if (_this._resizing) {
            let x = e.screenX - _this._beginCursorX;
            let y = e.screenY - _this._beginCursorY;
            let klass = _this._resizeTrigger.getAttribute('class').split(' ');
            if (klass.indexOf('tl') != -1) {
              _this.x = _this._beginX + x;
              _this.y = _this._beginY + y;
              _this.height = _this._beginHeight - y;
              _this.width = _this._beginWidth - x;
            }
            if (klass.indexOf('tr') != -1) {
              _this.y = _this._beginY + y;
              _this.height = _this._beginHeight - y;
              _this.width = _this._beginWidth + x;
            }
            if (klass.indexOf('bl') != -1) {
              _this.x = _this._beginX + x;
              _this.height = _this._beginHeight + y;
              _this.width = _this._beginWidth - x;
            }
            if(klass.indexOf('br') != -1) {
              _this.height = _this._beginHeight + y;
              _this.width = _this._beginWidth + x;
            }
          }
        });
      }

      update() {
        this.style.left = this.x + 'px';
        this.style.top = this.y + 'px';
        this.style.height = this.height + 'px';
        this.style.width = this.width + 'px';
      }

      _posPolicyChanged(policy) {
        if (!this.opened) {
          return;
        }
        let pos = { x: this.fixX, y: this.fixY };
        switch(policy) {
          case POS_TOP_LEFT:
            pos = this.topLeft();
            break;
          case POS_TOP_RIGHT:
            pos = this.topRight();
            break;
          case POS_TOP:
            pos = this.top();
            break;
          case POS_LEFT:
            pos = this.left();
            break;
          case POS_CENTER:
            pos = this.center();
            break;
          case POS_RIGHT:
            pos = this.right();
            break;
          case POS_BOTTOM_LEFT:
            pos = this.bottomLeft();
            break;
          case POS_BOTTOM:
            pos = this.bottom();
            break;
          case POS_BOTTOM_RIGHT:
            pos = this.bottomRight();
            break;
        }
        this.x = pos.x;
        this.y = pos.y;
      }

      _openedChanged(opened, old) {
        if (opened) {
          this.style.display = 'block';
          this._posPolicyChanged(this.posPolicy);
          this.animate(this.openAnimationConfig, this.openDuration);
          return;
        }
        if (old === undefined) {
          this.style.display = 'none';
          return;
        }
        let ani = this.animate(this.closeAnimationConfig, this.closeDuration);
        ani.pause();
        let _this = this;
        ani.onfinish = () => {
          _this.style.display = 'none';
        };
        ani.play();
      }

      static get screenWidth() {
        if (document.documentElement.clientWidth) {
          return document.documentElement.clientWidth;
        }
        return document.body.clientWidth;
      }

      static get screenHeight() {
        if (document.documentElement.clientHeight) {
          return document.documentElement.clientHeight;
        }
        return document.body.clientHeight;
      }
    }

    window.customElements.define(BooWindow.is, BooWindow);
  </script>
</dom-module>
